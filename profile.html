<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile - FarmFresh</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
  <!-- Left Sidebar -->
  <div class="w-1/4 bg-white shadow-lg p-6 flex flex-col">
    <!-- Profile Header -->
    <div class="text-center mb-6">
      <img id="profilePic" src="https://via.placeholder.com/100" class="w-24 h-24 mx-auto rounded-full border-4 border-blue-500" alt="Profile" />
      <h2 id="profileName" class="text-2xl font-bold mt-2">Guest</h2>
      <p id="profileEmail" class="text-gray-500">No email</p>
      <p id="profilePhone" class="text-gray-500">üìû Not provided</p>
      <p id="profileAddress" class="text-gray-500">üè† Address not provided</p>
    </div>

    <!-- Logout -->
    <button id="logoutBtn" class="flex items-center space-x-2 bg-red-500 text-white px-4 py-2 rounded-full shadow hover:bg-red-600 transition mb-6 justify-center">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Logout</span>
    </button>

    <!-- Menu Options -->
    <div class="space-y-3 mt-2 flex-1">
      <button class="option-btn flex items-center space-x-3 p-3 rounded-xl w-full text-left hover:bg-indigo-100 transition" data-content="address">
        <i class="fa-solid fa-location-dot text-indigo-500 text-xl"></i>
        <span>Address</span>
      </button>
      <button class="option-btn flex items-center space-x-3 p-3 rounded-xl w-full text-left hover:bg-gray-200 transition" data-content="editProfile">
        <i class="fa-solid fa-pen-to-square text-gray-600 text-xl"></i>
        <span>Edit Profile</span>
      </button>
      <button class="option-btn flex items-center space-x-3 p-3 rounded-xl w-full text-left hover:bg-green-100 transition" data-content="history">
        <i class="fa-solid fa-clock-rotate-left text-green-500 text-xl"></i>
        <span>History</span>
      </button>
      <button class="option-btn flex items-center space-x-3 p-3 rounded-xl w-full text-left hover:bg-yellow-100 transition" data-content="help">
        <i class="fa-solid fa-circle-info text-yellow-500 text-xl"></i>
        <span>Help</span>
      </button>
    </div>
  </div>

  <!-- Right Content Area -->
  <div class="flex-1 p-8 bg-gray-50 overflow-auto">
    <div class="flex items-center justify-between mb-4">
      <button id="backBtn" class="flex items-center space-x-2 text-gray-700 bg-white px-4 py-2 rounded shadow hover:bg-gray-100 transition">
        <i class="fa-solid fa-arrow-left"></i>
        <span>Back</span>
      </button>
    </div>
    <div id="contentArea" class="h-full flex items-center justify-center">
      <div class="bg-gradient-to-r from-green-400 to-blue-500 shadow-2xl rounded-3xl p-12 w-3/4 text-center text-white transform hover:scale-105 transition">
        <h1 class="text-4xl font-bold mb-4">Welcome to FarmFresh!</h1>
        <p class="text-lg">Your one-stop solution for fresh groceries delivered to your doorstep.</p>
        <i class="fa-solid fa-leaf text-6xl mt-6"></i>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------- Utilities -------------------- */
function safeParse(json, fallback) { try { return JSON.parse(json); } catch { return fallback; } }

function getUser() {
  return safeParse(localStorage.getItem("userProfile"), {});
}

function saveUser(user) { 
  localStorage.setItem("userProfile", JSON.stringify(user)); 
}

function setAvatarFromName(name) {
  const url = `https://ui-avatars.com/api/?name=${encodeURIComponent(name||"G")}&background=random&color=fff&bold=true`;
  const img = document.getElementById("profilePic"); 
  if(img) img.src = url;
}

/* -------------------- Initial Load -------------------- */
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem('token');
  
  if (!token) {
    alert("Please login first!");
    window.location.href = "login.html";
    return;
  }

  // Fetch fresh profile data from backend
  try {
    const response = await fetch('http://localhost:5000/api/profile', {
      headers: { 'Authorization': token }
    });
    
    const data = await response.json();
    
    if (data.success && data.user) {
      // Update localStorage with fresh data
      saveUser(data.user);
      
      // Update UI
      document.getElementById("profileName").textContent = data.user.name || "Guest";
      document.getElementById("profileEmail").textContent = data.user.email || "No email";
      document.getElementById("profilePhone").textContent = data.user.phone || "üìû Not provided";
      document.getElementById("profileAddress").textContent = data.user.address || "üè† Address not provided";
      setAvatarFromName(data.user.name);
    } else {
      throw new Error('Failed to fetch profile');
    }
  } catch (err) {
    console.error('Error loading profile:', err);
    alert('Error loading profile. Please login again.');
    localStorage.clear();
    window.location.href = "login.html";
    return;
  }

  document.querySelectorAll(".option-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{ renderTab(btn.getAttribute("data-content")); });
  });

  const backBtn = document.getElementById("backBtn");
  if (backBtn) {
    backBtn.addEventListener("click", () => {
      window.location.href = "webpage.html";
    });
  }
});

/* -------------------- Logout -------------------- */
document.getElementById("logoutBtn").addEventListener("click",()=>{
  localStorage.clear();
  sessionStorage.clear();
  window.location.href="web.html";
});

/* -------------------- Tabs -------------------- */
const contentArea = document.getElementById("contentArea");

function renderTab(key){
  if(key==="address") renderAddressTab();
  else if(key==="editProfile") renderEditProfileTab();
  else if(key==="history") renderHistoryTab();
  else if(key==="help") renderHelpTab();
}

/* ---------- Address Tab ---------- */
function renderAddressTab(){
  const user = getUser();
  const address = user.address || '';
  
  contentArea.innerHTML=`
    <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-2xl">
      <h2 class="text-3xl font-bold mb-6">Delivery Address</h2>
      <div class="mb-6">
        <h3 class="font-semibold mb-2">Current Address</h3>
        <p class="text-gray-600 p-4 border rounded-lg">${address || 'No address set'}</p>
      </div>
      <div class="mt-4">
        <h3 class="font-semibold mb-2">Update Address</h3>
        <textarea id="newAddress" class="w-full border rounded-lg p-3 mb-3" placeholder="Enter your full delivery address">${address}</textarea>
        <button id="updateAddressBtn" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">Update Address</button>
      </div>
    </div>
  `;
  
  document.getElementById("updateAddressBtn").addEventListener("click", async () => {
    const newAddress = document.getElementById("newAddress").value.trim();
    if(!newAddress) return alert("Please enter an address.");
    
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch('http://localhost:5000/api/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: JSON.stringify({ address: newAddress })
      });
      
      const data = await response.json();
      
      if (data.success) {
        saveUser(data.user);
        document.getElementById("profileAddress").textContent = data.user.address;
        alert("‚úÖ Address updated successfully!");
        renderAddressTab();
      } else {
        alert(data.message || 'Failed to update address');
      }
    } catch (err) {
      console.error('Error updating address:', err);
      alert('Error updating address. Please try again.');
    }
  });
}

/* ---------- Edit Profile Tab ---------- */
function renderEditProfileTab(){
  const user = getUser();
  
  contentArea.innerHTML=`
    <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-2xl">
      <h2 class="text-3xl font-bold mb-4">Edit Profile</h2>
      <div class="space-y-4">
        <div>
          <label class="block font-semibold mb-2">Name</label>
          <input type="text" id="editName" class="w-full p-3 border rounded-lg" value="${user.name||""}" />
        </div>
        <div>
          <label class="block font-semibold mb-2">Email</label>
          <input type="email" id="editEmail" class="w-full p-3 border rounded-lg bg-gray-100" value="${user.email||""}" disabled />
          <p class="text-sm text-gray-500 mt-1">Email cannot be changed</p>
        </div>
        <div>
          <label class="block font-semibold mb-2">Phone</label>
          <input type="text" id="editPhone" class="w-full p-3 border rounded-lg" value="${user.phone||""}" />
        </div>
        <div>
          <label class="block font-semibold mb-2">Address</label>
          <textarea id="editAddress" class="w-full p-3 border rounded-lg" rows="3">${user.address||""}</textarea>
        </div>
        <button id="saveProfile" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-bold">
          Save Changes
        </button>
      </div>
    </div>
  `;
  
  document.getElementById("saveProfile").addEventListener("click", async () => {
    const name = document.getElementById("editName").value.trim();
    const phone = document.getElementById("editPhone").value.trim();
    const address = document.getElementById("editAddress").value.trim();
    
    if (!name) return alert("Name is required");
    
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch('http://localhost:5000/api/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: JSON.stringify({ name, phone, address })
      });
      
      const data = await response.json();
      
      if (data.success) {
        saveUser(data.user);
        document.getElementById("profileName").textContent = data.user.name;
        document.getElementById("profilePhone").textContent = data.user.phone || "üìû Not provided";
        document.getElementById("profileAddress").textContent = data.user.address || "üè† Address not provided";
        setAvatarFromName(data.user.name);
        alert("‚úÖ Profile updated successfully!");
      } else {
        alert(data.message || 'Failed to update profile');
      }
    } catch (err) {
      console.error('Error updating profile:', err);
      alert('Error updating profile. Please try again.');
    }
  });
}

/* ---------- History Tab ---------- */
async function renderHistoryTab(){
  const token = localStorage.getItem("token");
  
  if (!token) {
    contentArea.innerHTML = `
      <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-2xl text-center">
        <p class="text-red-500">‚ö†Ô∏è Please log in to see your history.</p>
      </div>`;
    return;
  }

  contentArea.innerHTML = `
    <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-4xl">
      <h2 class="text-3xl font-bold mb-6">Purchase History</h2>
      <div id="ordersWrap" class="space-y-6"><p class="text-gray-500">Loading...</p></div>
    </div>`;

  const wrap = document.getElementById("ordersWrap");

  try {
    const res = await fetch("http://localhost:5000/api/orders", {
      headers: { "Authorization": token }
    });
    const result = await res.json();

    if (!result.success || !Array.isArray(result.orders) || result.orders.length === 0) {
      wrap.innerHTML = `<p class="text-gray-500">No purchase history yet.</p>`;
      return;
    }

    wrap.innerHTML = result.orders.map((order, idx) => `
      <div class="border rounded-2xl p-6 shadow">
        <div class="flex flex-wrap items-center justify-between gap-2 mb-4">
          <h3 class="font-bold text-xl">Order #${result.orders.length - idx}</h3>
          <div class="text-sm text-gray-600">${new Date(order.createdAt).toLocaleString()}</div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          ${order.items.map(it => `
            <div class="flex items-center space-x-4 p-3 border rounded-lg">
              <img src="${it.image || 'https://via.placeholder.com/80'}" class="w-16 h-16 object-cover rounded-lg" alt="${it.name}" />
              <div>
                <p class="font-semibold">${it.name}</p>
                <p class="text-gray-500">‚Çπ${Number(it.price).toFixed(2)} √ó ${Number(it.quantity)}</p>
              </div>
            </div>
          `).join("")}
        </div>
        <div class="mt-4 flex items-center justify-between">
          <div class="text-gray-600 text-sm">${order.items.length} item(s)</div>
          <div class="text-right">
            <p class="font-semibold text-lg">Total: ‚Çπ${Number(order.total).toFixed(2)}</p>
          </div>
        </div>
      </div>
    `).join("");
  } catch (err) {
    console.error(err);
    wrap.innerHTML = `<p class="text-red-500">‚ùå Error loading history. Please check if backend is running.</p>`;
  }
}

/* ---------- Help Tab ---------- */
function renderHelpTab(){
  contentArea.innerHTML=`
    <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-2xl">
      <h2 class="text-3xl font-bold mb-4">Help & Support</h2>
      <div class="border rounded-lg p-4 h-64 flex flex-col">
        <div class="flex-1 overflow-y-auto mb-4" id="chatMessages">
          <div class="text-left mb-2">
            <span class="bg-gray-200 px-3 py-1 rounded-lg inline-block">Hello! How can we help you today?</span>
          </div>
        </div>
        <div class="flex space-x-2">
          <input id="chatInput" type="text" placeholder="Type your message..." class="flex-1 border rounded-lg px-3 py-2" />
          <button id="chatSend" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Send</button>
        </div>
      </div>
    </div>
  `;
  
  const input = document.getElementById("chatInput");
  const messages = document.getElementById("chatMessages");
  
  document.getElementById("chatSend").addEventListener("click",()=>{
    const msg = (input.value||"").trim(); 
    if(!msg) return;
    
    messages.innerHTML+=`<div class="text-right mb-2"><span class="bg-blue-500 text-white px-3 py-1 rounded-lg inline-block">${msg}</span></div>`;
    input.value="";
    
    setTimeout(()=>{
      messages.innerHTML+=`<div class="text-left mb-2"><span class="bg-gray-200 px-3 py-1 rounded-lg inline-block">Thank you for your message! Our support team will get back to you shortly.</span></div>`;
      messages.scrollTop = messages.scrollHeight;
    },600);
    
    messages.scrollTop = messages.scrollHeight;
  });
  
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById("chatSend").click();
    }
  });
}
</script>
</body>
</html>